server {
  include snippets/{{ item.service_name|default(item.name) }}_listen;

  server_name
    {% if item.www_subdomain|default(false) %}www.{% endif %}{{ item.name }}
    {% for alt in item.alternatives|default([]) %}
      {% if alt.www_subdomain|default(false) %}www.{% endif %}{{ alt.name }}
    {% endfor %}
  ;

  {% for location in item.locations|default([]) %}
    location {{ location.path }} {
      {% if location.proxy|default(false) %}
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_pass {{ location.proxy.pass }};
      {% endif %}
    }
  {% endfor %}

  root /usr/local/www/{{ item.name }};
}

{% if item.www_subdomain|default(false) or (item.alternatives|default([])|selectattr('www_subdomain', 'defined')|selectattr('www_subdomain')|list|length) > 0 %}
  ## redirect missing www.

  server {
    include snippets/{{ item.service_name|default(item.name) }}_listen;

    server_name
      {% if item.www_subdomain|default(false) %}{{ item.name }}{% endif %}
      {% for alt in item.alternatives|default([])|selectattr('www_subdomain', 'defined')|selectattr('www_subdomain') %}
        {{ alt.name }}
      {% endfor %}
    ;

    return 301 $scheme://www.$host$request_uri;
  }
{% endif %}
